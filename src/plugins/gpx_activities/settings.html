<div class="form-group">
    <div class="form-group nowrap">
        <label for="garminEmail" class="form-label">Garmin Email:</label>
        <input type="email" id="garminEmail" name="garminEmail" placeholder="name@example.com" class="form-input" autocomplete="username">
    </div>

    <div class="form-group nowrap">
        <label for="garminPassword" class="form-label">Garmin Password:</label>
        <input type="password" id="garminPassword" name="garminPassword" placeholder="Enter password" class="form-input" autocomplete="current-password">
    </div>

    <div class="form-group nowrap">
        <label for="minDistanceKm" class="form-label">Min Distance (km):</label>
        <input type="number" id="minDistanceKm" name="minDistanceKm" min="0" step="0.1" value="20" class="form-input">
    </div>

    <input type="hidden" id="garminEmailKey" name="garminEmailKey">
    <input type="hidden" id="garminPasswordKey" name="garminPasswordKey">
</div>

<div class="form-group">
    <span style="color: var(--text-primary);">
        Displays Garmin road biking activities in Brussels from the last 6 months.
        Credentials are stored securely in <code>.env</code> and not saved in playlist config.
    </span>
</div>

<script>
    async function persistGarminSecrets() {
        const emailInput = document.getElementById('garminEmail');
        const passwordInput = document.getElementById('garminPassword');
        const emailKeyInput = document.getElementById('garminEmailKey');
        const passwordKeyInput = document.getElementById('garminPasswordKey');

        const email = (emailInput.value || '').trim();
        const password = (passwordInput.value || '').trim();
        const currentEmailKey = (emailKeyInput.value || '').trim();
        const currentPasswordKey = (passwordKeyInput.value || '').trim();

        const hasExistingKeys = Boolean(currentEmailKey && currentPasswordKey);
        const shouldSave = Boolean(email || password || !hasExistingKeys);

        if (!shouldSave) {
            return;
        }

        if (!email) {
            throw new Error('Garmin email is required.');
        }
        if (!password && !hasExistingKeys) {
            throw new Error('Garmin password is required.');
        }

        const response = await fetch('{{ url_for("plugin.save_garmin_credentials") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email,
                password,
                current_email_key: currentEmailKey,
                current_password_key: currentPasswordKey
            })
        });

        const result = await response.json();
        if (!response.ok) {
            throw new Error(result.error || 'Failed to save Garmin credentials.');
        }

        emailKeyInput.value = result.email_key;
        passwordKeyInput.value = result.password_key;
        passwordInput.value = '';

        if (loadPluginSettings) {
            emailInput.value = '';
            emailInput.placeholder = 'Stored securely (enter to replace)';
        }
    }

    // Wrap global action handler to persist secrets before submit.
    const originalHandleAction = window.handleAction;
    window.handleAction = async function(action) {
        try {
            await persistGarminSecrets();
            return await originalHandleAction(action);
        } catch (error) {
            showResponseModal('failure', `Error! ${error.message || error}`);
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const minDistanceInput = document.getElementById('minDistanceKm');
        const emailInput = document.getElementById('garminEmail');
        const passwordInput = document.getElementById('garminPassword');
        const emailKeyInput = document.getElementById('garminEmailKey');
        const passwordKeyInput = document.getElementById('garminPasswordKey');

        if (loadPluginSettings) {
            minDistanceInput.value = pluginSettings.minDistanceKm || '20';
            emailKeyInput.value = pluginSettings.garminEmailKey || '';
            passwordKeyInput.value = pluginSettings.garminPasswordKey || '';

            if (pluginSettings.garminEmailKey) {
                emailInput.placeholder = 'Stored securely (enter to replace)';
            }
            if (pluginSettings.garminPasswordKey) {
                passwordInput.placeholder = 'Stored securely (enter to replace)';
            }
        } else {
            minDistanceInput.value = '20';
        }
    });
</script>
